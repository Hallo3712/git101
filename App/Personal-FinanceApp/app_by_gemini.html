<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Productivity Hub: แอปจัดการงานและเวลาส่วนตัว</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/heroicons/2.1.1/24/outline/academic-cap.svg" rel="stylesheet">
    <style>
        /* This section contains explicit Tailwind classes used dynamically 
           to ensure they are not purged by the CDN compiler. */

        /* Eisenhower Matrix Colors */
        .text-red-600 {
            color: #dc2626;
        }

        .border-red-400 {
            border-color: #f87171;
        }

        .text-blue-600 {
            color: #2563eb;
        }

        .border-blue-400 {
            border-color: #60a5fa;
        }

        .text-yellow-600 {
            color: #d97706;
        }

        .border-yellow-400 {
            border-color: #facc15;
        }

        .text-gray-600 {
            color: #4b5563;
        }

        .border-gray-400 {
            border-color: #9ca3af;
        }

        /* Chart Colors (for dynamic rendering) */
        .bg-green-600 {
            background-color: #059669;
        }

        body {
            font-family: 'Inter', 'Kanit', sans-serif;
        }

        .sidebar {
            transition: transform 0.3s ease-in-out;
        }

        .sidebar-open {
            transform: translateX(0);
        }

        .sidebar-closed {
            transform: translateX(-100%);
        }

        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease-in-out;
        }

        .task-card {
            transition: box-shadow 0.2s ease-in-out, transform 0.2s ease-in-out;
        }

        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }

        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Inter:wght@400;500;600;700&display=swap"
        rel="stylesheet">
</head>

<body class="bg-gray-50 text-gray-800">

    <div id="app-container" class="flex h-screen overflow-hidden">
        <!-- Sidebar Navigation -->
        <aside id="sidebar"
            class="sidebar sidebar-closed md:w-64 bg-white border-r border-gray-200 absolute inset-y-0 left-0 z-30 md:relative md:translate-x-0">
            <div class="p-4 border-b">
                <h2 class="text-xl font-bold text-gray-700">Productivity Hub</h2>
                <p id="user-id-display" class="text-xs text-gray-400 truncate mt-1">กำลังโหลด...</p>
            </div>
            <nav class="mt-4">
                <a href="#" class="nav-link flex items-center px-4 py-3 text-gray-600 hover:bg-gray-100"
                    data-view="eisenhower-view">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                    <span>รายการงานทั้งหมด</span>
                </a>
                <a href="#" class="nav-link flex items-center px-4 py-3 text-gray-600 hover:bg-gray-100"
                    data-view="daily-plan-view">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                        </path>
                    </svg>
                    <span>แผนงานวันนี้</span>
                </a>
                <a href="#" class="nav-link flex items-center px-4 py-3 text-gray-600 hover:bg-gray-100"
                    data-view="habit-tracker-view">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.085a2 2 0 00-1.736.93L5.5 8m7 2v5m0 0v5m0-5h5">
                        </path>
                    </svg>
                    <span>ตัวติดตามนิสัย</span>
                </a>
                <a href="#" class="nav-link flex items-center px-4 py-3 text-gray-600 hover:bg-gray-100"
                    data-view="calendar-view">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                        </path>
                    </svg>
                    <span>ปฏิทิน</span>
                </a>
                <a href="#" class="nav-link flex items-center px-4 py-3 text-gray-600 hover:bg-gray-100"
                    data-view="stats-view">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path>
                    </svg>
                    <span>สถิติและรายงาน</span>
                </a>
                <a href="#" class="nav-link flex items-center px-4 py-3 text-gray-600 hover:bg-gray-100"
                    data-view="trash-view">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                        </path>
                    </svg>
                    <span>ถังขยะ</span>
                </a>
                <a href="#" class="nav-link flex items-center px-4 py-3 text-gray-600 hover:bg-gray-100"
                    data-view="settings-view">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                        </path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    <span>การตั้งค่า</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col">
            <header
                class="bg-white border-b border-gray-200 p-3 flex flex-col md:flex-row justify-between items-center space-y-2 md:space-y-0">
                <div class="flex items-center">
                    <button id="sidebar-toggle" class="md:hidden text-gray-500 mr-3">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                    <h1 id="view-title" class="text-xl font-semibold">รายการงานทั้งหมด</h1>
                </div>
                <!-- Pomodoro Timer Controls -->
                <div id="pomodoro-controls"
                    class="flex items-center space-x-3 bg-gray-100 p-2 rounded-full shadow-inner">
                    <div id="pomodoro-timer" class="text-lg font-mono font-bold text-blue-700 w-16 text-center">25:00
                    </div>
                    <span id="timer-status" class="text-sm text-gray-600">โฟกัส</span>
                    <button id="timer-start-pause"
                        class="text-blue-600 hover:text-blue-800 p-1 rounded-full bg-white shadow">
                        <svg id="play-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M14.752 11.168l-3.197 2.132A1 1 0 0110.25 13V9a1 1 0 011.305-.992l3.197 2.132a1 1 0 010 1.656z">
                            </path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <svg id="pause-icon" class="w-5 h-5 hidden" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </button>
                    <button id="timer-reset" class="text-gray-500 hover:text-gray-700 p-1">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 4v5h.582m15.356-2A8.991 8.991 0 0120.945 13H15m-1.556-4.757l1.066 1.067"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M20 20v-5h-.581m-15.357 2A8.991 8.991 0 013.055 11H9m1.556 4.757l-1.066-1.067">
                            </path>
                        </svg>
                    </button>
                </div>
                <!-- End Pomodoro Controls -->
            </header>

            <main class="flex-1 p-6 overflow-y-auto bg-gray-100">
                <!-- Views will be injected here -->
                <div id="eisenhower-view" class="view"></div>
                <div id="daily-plan-view" class="view hidden"></div>
                <div id="habit-tracker-view" class="view hidden"></div>
                <div id="calendar-view" class="view hidden"></div>
                <div id="stats-view" class="view hidden"></div>
                <div id="trash-view" class="view hidden"></div>
                <div id="settings-view" class="view hidden"></div>
            </main>
        </div>
    </div>

    <!-- Floating Add Button -->
    <button id="add-task-btn"
        class="fixed bottom-8 right-8 bg-blue-600 text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg hover:bg-blue-700 transition z-20">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
        </svg>
    </button>

    <!-- Modals -->

    <!-- Add/Edit Task Modal -->
    <div id="task-modal" class="modal-backdrop fixed inset-0 z-40 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg mx-4">
            <h3 id="modal-title" class="text-2xl font-bold mb-4">สร้างงานใหม่</h3>
            <form id="task-form">
                <input type="hidden" id="task-id">
                <div class="mb-4">
                    <label for="task-title" class="block text-sm font-medium text-gray-700">ชื่องาน</label>
                    <input type="text" id="task-title"
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                        required>
                </div>
                <div class="mb-4">
                    <label for="task-description" class="block text-sm font-medium text-gray-700">รายละเอียด</label>
                    <textarea id="task-description" rows="3"
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                <div class="mb-4">
                    <label for="task-due-date" class="block text-sm font-medium text-gray-700">วันที่กำหนดส่ง</label>
                    <input type="date" id="task-due-date"
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="mb-4">
                    <label for="task-eisenhower" class="block text-sm font-medium text-gray-700">จัดลำดับความสำคัญ
                        (Eisenhower)</label>
                    <select id="task-eisenhower"
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="do">สำคัญ / เร่งด่วน (Do)</option>
                        <option value="decide">สำคัญ / ไม่เร่งด่วน (Decide)</option>
                        <option value="delegate">ไม่สำคัญ / เร่งด่วน (Delegate)</option>
                        <option value="delete">ไม่สำคัญ / ไม่เร่งด่วน (Delete)</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="task-reward" class="block text-sm font-medium text-gray-700">รางวัลเมื่องานเสร็จ
                        (ถ้ามี)</label>
                    <select id="task-reward"
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="">ไม่มีรางวัล</option>
                    </select>
                </div>

                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-task-btn"
                        class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">ยกเลิก</button>
                    <button type="submit"
                        class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">บันทึก</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Action/Reward Modal -->
    <div id="action-modal" class="modal-backdrop fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-sm mx-4 text-center">
            <h3 id="action-title" class="text-2xl font-bold mb-3 text-green-600">สำเร็จ!</h3>
            <p id="action-message" class="text-gray-700 mb-6"></p>
            <div class="flex justify-center space-x-4">
                <button type="button" id="start-break-btn"
                    class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 font-semibold">เริ่มพัก!</button>
                <button type="button" id="close-action-btn"
                    class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">ปิด</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase SDK imports for Realtime Database (RTDB)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, onValue, set, push, remove, update } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // IMPORTANT: REPLACE THESE WITH YOUR OWN FIREBASE CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyCJQ9hVsMFm5LYKPvyAA342XcBh4iAI9Ek",
            authDomain: "create-app-e4028.firebaseapp.com",
            databaseURL: "https://create-app-e4028-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "create-app-e4028",
            storageBucket: "create-app-e4028.firebasestorage.app",
            messagingSenderId: "612684670881",
            appId: "1:612684670881:web:3650b675274176a8db8de0"
        };

        const DEFAULT_WORK_MINUTES = 25;
        const DEFAULT_BREAK_MINUTES = 5;

        // Check for placeholder config and warn the user
        if (firebaseConfig.apiKey === "YOUR_API_KEY") {
            document.body.innerHTML = `<div class="p-8 text-center bg-red-100 text-red-800 h-screen flex flex-col items-center justify-center">
                <h1 class="text-3xl font-bold mb-4">ข้อผิดพลาดในการตั้งค่า Firebase</h1>
                <p class="mt-2 text-lg">กรุณาแทนที่ค่าในตัวแปร <code class="bg-red-200 p-1 rounded font-mono">firebaseConfig</code> ด้วยข้อมูล Firebase Realtime Database ของคุณเพื่อใช้งาน</p>
            </div>`;
            throw new Error("Firebase configuration is missing or using placeholders.");
        }


        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let userId = null;
        let dataRef = null;

        // --- State Management ---
        let tasks = {};
        let rewards = {};
        let trash = {};
        let currentView = 'eisenhower-view';

        // --- Pomodoro State ---
        let timerInterval = null;
        let isTimerRunning = false;
        let isBreak = false;
        let timeRemaining = DEFAULT_WORK_MINUTES * 60; // seconds

        // --- UI Elements ---
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const navLinks = document.querySelectorAll('.nav-link');
        const views = document.querySelectorAll('.view');
        const viewTitle = document.getElementById('view-title');
        const addTaskBtn = document.getElementById('add-task-btn');
        const taskModal = document.getElementById('task-modal');
        const taskForm = document.getElementById('task-form');
        const cancelTaskBtn = document.getElementById('cancel-task-btn');
        const modalTitle = document.getElementById('modal-title');
        const userIdDisplay = document.getElementById('user-id-display');

        // Pomodoro UI Elements
        const timerDisplay = document.getElementById('pomodoro-timer');
        const timerStatus = document.getElementById('timer-status');
        const startPauseBtn = document.getElementById('timer-start-pause');
        const resetBtn = document.getElementById('timer-reset');
        const playIcon = document.getElementById('play-icon');
        const pauseIcon = document.getElementById('pause-icon');

        // Action/Reward Modal Elements
        const actionModal = document.getElementById('action-modal');
        const actionTitle = document.getElementById('action-title');
        const actionMessage = document.getElementById('action-message');
        const startBreakBtn = document.getElementById('start-break-btn');
        const closeActionBtn = document.getElementById('close-action-btn');

        // --- Authentication and Setup ---

        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                // Using RTDB path convention
                dataRef = ref(db, `users/${userId}`);
                userIdDisplay.textContent = `User ID: ${userId}`;

                // Start listening to the database AFTER authentication
                setupDatabaseListeners();
                switchView(currentView);
            } else {
                // Sign in anonymously if not authenticated
                signInAnonymously(auth).catch(error => {
                    console.error("Anonymous sign in failed:", error);
                    userIdDisplay.textContent = "AUTH ERROR";
                });
            }
        });

        function setupDatabaseListeners() {
            // Listen for tasks updates
            onValue(ref(dataRef, 'tasks'), (snapshot) => {
                tasks = snapshot.val() || {};
                renderView(currentView);
            });

            // Listen for rewards updates
            onValue(ref(dataRef, 'rewards'), (snapshot) => {
                rewards = snapshot.val() || {};
                if (currentView === 'settings-view') renderView(currentView);
                // Rerender the modal if it's open to update rewards list (important fix)
                const taskId = document.getElementById('task-id')?.value;
                if (!taskModal.classList.contains('hidden') && taskId && tasks[taskId]) {
                    openTaskModal(tasks[taskId]);
                } else if (!taskModal.classList.contains('hidden')) {
                    openTaskModal(null); // Just ensure rewards are updated for new task
                }
            });

            // Listen for trash updates
            onValue(ref(dataRef, 'trash'), (snapshot) => {
                trash = snapshot.val() || {};
                if (currentView === 'trash-view') renderView(currentView);
            });
        }

        // --- Pomodoro Logic ---
        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function handleTimerEnd() {
            clearInterval(timerInterval);
            timerInterval = null;
            isTimerRunning = false;

            // Visual cue
            timerStatus.textContent = isBreak ? "พักเสร็จแล้ว!" : "หมดเวลาโฟกัส!";
            timerDisplay.classList.add('animate-pulse', isBreak ? 'text-blue-700' : 'text-red-600');

            pauseIcon.classList.add('hidden');
            playIcon.classList.remove('hidden');

            // Automatically reset to work timer after break ends
            if (isBreak) {
                setTimeout(() => resetTimer(false), 2000);
            }
        }

        function startTimer(durationSeconds, isForBreak = false) {
            if (timerInterval) clearInterval(timerInterval);

            isBreak = isForBreak;
            timeRemaining = durationSeconds;
            isTimerRunning = true;

            timerDisplay.classList.remove('animate-pulse', 'text-red-600', 'text-green-600', 'text-blue-700');
            timerDisplay.classList.add(isBreak ? 'text-green-600' : 'text-blue-700');
            timerStatus.textContent = isBreak ? "กำลังพัก" : "กำลังโฟกัส";

            pauseIcon.classList.remove('hidden');
            playIcon.classList.add('hidden');

            updateTimerDisplay();

            timerInterval = setInterval(() => {
                if (timeRemaining <= 0) {
                    handleTimerEnd();
                    return;
                }
                timeRemaining--;
                updateTimerDisplay();
            }, 1000);
        }

        function pauseTimer() {
            if (!isTimerRunning) return;
            clearInterval(timerInterval);
            timerInterval = null;
            isTimerRunning = false;
            timerStatus.textContent = isBreak ? "หยุดพักชั่วคราว" : "หยุดโฟกัสชั่วคราว";
            pauseIcon.classList.add('hidden');
            playIcon.classList.remove('hidden');
        }

        function resetTimer(isForBreak = false) {
            pauseTimer();
            isBreak = isForBreak;
            timeRemaining = isBreak ? DEFAULT_BREAK_MINUTES * 60 : DEFAULT_WORK_MINUTES * 60;
            timerStatus.textContent = isBreak ? "พร้อมพัก" : "พร้อมโฟกัส";
            timerDisplay.classList.remove('animate-pulse', 'text-red-600', 'text-green-600');
            timerDisplay.classList.add(isBreak ? 'text-green-600' : 'text-blue-700');
            updateTimerDisplay();
        }

        function toggleTimer() {
            if (isTimerRunning) {
                pauseTimer();
            } else {
                startTimer(timeRemaining, isBreak);
            }
        }

        // --- View Templates ---
        const viewTemplates = {
            'eisenhower-view': () => {
                const quadrants = {
                    do: { title: 'สำคัญ / เร่งด่วน (Do)', tasks: [], color: 'red' },
                    decide: { title: 'สำคัญ / ไม่เร่งด่วน (Decide)', tasks: [], color: 'blue' },
                    delegate: { title: 'ไม่สำคัญ / เร่งด่วน (Delegate)', tasks: [], color: 'yellow' },
                    delete: { title: 'ไม่สำคัญ / ไม่เร่งด่วน (Delete)', tasks: [], color: 'gray' }
                };

                Object.entries(tasks).forEach(([id, task]) => {
                    if (task.eisenhower && quadrants[task.eisenhower] && !task.isCompleted) {
                        // Attach ID to task object for easier access in rendering
                        quadrants[task.eisenhower].tasks.push({ id, ...task });
                    }
                });

                // Sort tasks within quadrants: prioritize by due date (if available) then creation date
                Object.values(quadrants).forEach(quadrant => {
                    quadrant.tasks.sort((a, b) => {
                        const dateA = a.dueDate ? new Date(a.dueDate) : new Date(a.createdAt);
                        const dateB = b.dueDate ? new Date(b.dueDate) : new Date(b.createdAt);
                        return dateA - dateB;
                    });
                });

                return `
                    <p class="text-gray-600 mb-6">เมทริกซ์ Eisenhower ช่วยให้คุณจัดลำดับความสำคัญของงานตามความเร่งด่วนและความสำคัญ</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        ${Object.entries(quadrants).map(([key, { title, tasks, color }]) => `
                            <div class="bg-white rounded-xl shadow-lg p-5 border-t-4 border-${color}-400">
                                <h3 class="text-xl font-semibold text-${color}-600 pb-2 mb-4">${title}</h3>
                                <div id="quadrant-${key}" class="space-y-3 min-h-[100px]">
                                    ${tasks.length > 0 ? tasks.map(task => createTaskCard(task)).join('') : '<p class="text-gray-500 text-sm italic">ว่างเปล่า – งานเสร็จแล้ว หรือไม่มีงานที่ต้องเร่งด่วน</p>'}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            },
            'daily-plan-view': () => `
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-2xl font-bold mb-4">แผนงานสำหรับวันนี้ (Ivy Lee)</h2>
                    <p class="text-gray-600 mb-6">หลักการ Ivy Lee: เลือก 6 งานที่สำคัญที่สุดเมื่อวานนี้ และทำทีละอย่างวันนี้</p>
                    <div id="daily-tasks-list" class="space-y-3">
                        <div class="p-4 bg-blue-50 border-l-4 border-blue-400 text-blue-800 rounded">ฟีเจอร์นี้จะช่วยให้คุณเลือกงานจากเมทริกซ์มาวางแผนประจำวันได้</div>
                        <p class="text-center text-gray-500 mt-4">ยังไม่มีการวางแผนสำหรับวันนี้</p>
                    </div>
                </div>
            `,
            'habit-tracker-view': () => `
                 <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-2xl font-bold mb-4">ตัวติดตามนิสัย</h2>
                     <p class="text-gray-600 mb-6">สร้างนิสัยที่ดีด้วยความสม่ำเสมอ</p>
                    <div id="habits-list" class="space-y-4">
                         <div class="p-4 bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 rounded">การติดตามนิสัยอยู่ระหว่างการพัฒนา</div>
                        <p class="text-center text-gray-500 mt-4">ยังไม่มีนิสัยให้ติดตาม</p>
                    </div>
                </div>
            `,
            'calendar-view': () => `
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-2xl font-bold mb-4">ปฏิทิน / Time Blocking</h2>
                    <p class="text-gray-600 mb-6">วางแผนเวลาของคุณเพื่อประสิทธิภาพสูงสุดด้วยเทคนิค Time Blocking</p>
                    <div class="p-4 bg-indigo-50 border-l-4 border-indigo-400 text-indigo-800 rounded">ตาราง Time Blocking จะถูกสร้างขึ้นที่นี่ในอนาคต</div>
                    <div class="text-center text-gray-500 mt-4">ฟีเจอร์ปฏิทินยังอยู่ในระหว่างการพัฒนา</div>
                </div>
            `,
            'stats-view': () => `
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-2xl font-bold mb-4">สถิติและรายงาน</h2>
                     <p class="text-gray-600 mb-6">วิเคราะห์ว่าคุณใช้เวลาไปกับงานประเภทใดบ้าง และอัตราความสำเร็จในแต่ละวัน</p>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h3 class="text-lg font-medium mb-2">งานที่เสร็จในสัปดาห์</h3>
                            <div class="chart-container"><canvas id="tasksCompletedChart"></canvas></div>
                        </div>
                        <div>
                            <h3 class="text-lg font-medium mb-2">สัดส่วนเวลาโฟกัส (Pomodoro)</h3>
                            <div class="chart-container"><canvas id="pomodoroSessionsChart"></canvas></div>
                        </div>
                    </div>
                </div>
            `,
            'trash-view': () => {
                // Sort by deletion date (descending)
                const trashedItems = Object.entries(trash).sort(([, a], [, b]) => new Date(b.deletedAt || 0) - new Date(a.deletedAt || 0));
                return `
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-2xl font-bold mb-4">ถังขยะ</h2>
                        <p class="text-gray-600 mb-6">งานที่คุณลบจะถูกเก็บไว้ที่นี่ชั่วคราวเพื่อกู้คืน</p>
                        <div id="trash-list" class="space-y-3">
                             ${trashedItems.length > 0 ? trashedItems.map(([id, item]) => createTrashedItemCard(id, item)).join('') : '<p class="text-gray-500">ถังขยะว่างเปล่า</p>'}
                        </div>
                    </div>
                `;
            },
            'settings-view': () => `
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-2xl font-bold mb-4">การตั้งค่า</h2>
                    <div id="rewards-settings" class="mb-8 border-b pb-6">
                         <h3 class="text-xl font-semibold mb-3 text-green-700">จัดการรางวัล (Reward System)</h3>
                         <p class="text-gray-600 mb-4">กำหนดรางวัลที่คุณจะได้รับหลังทำงานเสร็จสิ้น (รางวัลจะเปลี่ยนเป็นเวลาพัก)</p>
                        <div id="rewards-list" class="space-y-2 mb-4"></div>
                        <form id="add-reward-form" class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-2">
                            <input type="text" id="reward-name" placeholder="ชื่อรางวัล (เช่น พักดื่มกาแฟ)" class="flex-grow w-full border border-gray-300 rounded-md py-2 px-3" required>
                            <input type="number" id="reward-duration" placeholder="เวลาพัก (นาที)" class="w-full sm:w-32 border border-gray-300 rounded-md py-2 px-3" required>
                            <button type="submit" class="w-full sm:w-auto bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">เพิ่มรางวัล</button>
                        </form>
                    </div>
                </div>
            `,
        };

        // --- Core Functions ---

        function renderView(viewId) {
            views.forEach(v => v.classList.add('hidden'));
            const viewElement = document.getElementById(viewId);
            if (viewElement && viewTemplates[viewId]) {
                viewElement.innerHTML = viewTemplates[viewId]();
                viewElement.classList.remove('hidden');
                // Post-render actions
                if (viewId === 'stats-view') renderCharts();
                if (viewId === 'settings-view') renderRewardsSettings();
            }
        }

        function createTaskCard(task) {
            const rewardName = task.rewardId && rewards[task.rewardId] ? `(${rewards[task.rewardId].name} ${rewards[task.rewardId].duration} นาที)` : '';
            return `
                <div class="task-card border rounded-lg p-3 bg-white flex justify-between items-start" data-id="${task.id}" data-reward-id="${task.rewardId || ''}">
                    <div class="flex-1 min-w-0">
                        <p class="font-semibold text-gray-800 truncate">${task.title}</p>
                        ${task.description ? `<p class="text-sm text-gray-500 truncate">${task.description}</p>` : ''}
                        ${task.dueDate ? `<p class="text-xs text-indigo-500 mt-1">กำหนดส่ง: ${task.dueDate}</p>` : ''}
                        ${rewardName ? `<p class="text-xs text-green-600 mt-1 font-medium">รางวัล: ${rewardName}</p>` : ''}
                    </div>
                     <div class="flex items-center space-x-1 flex-shrink-0 ml-2">
                        <button class="complete-btn p-1 text-gray-400 hover:text-green-500" title="เสร็จสิ้น">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                        </button>
                        <button class="edit-btn p-1 text-gray-400 hover:text-blue-500" title="แก้ไข">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg>
                        </button>
                        <button class="delete-btn p-1 text-gray-400 hover:text-red-500" title="ลบ">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                </div>
            `;
        }

        function createTrashedItemCard(id, item) {
            return `
                <div class="border rounded-lg p-3 bg-gray-100 flex justify-between items-center" data-id="${id}">
                    <p class="font-semibold text-gray-600">${item.title}</p>
                    <div>
                        <button class="restore-btn bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">กู้คืน</button>
                    </div>
                </div>`;
        }

        function renderRewardsSettings() {
            const rewardsList = document.getElementById('rewards-list');
            // Ensure the list is empty before rendering
            rewardsList.innerHTML = '';

            rewardsList.innerHTML = Object.entries(rewards).map(([id, reward]) => `
                <div class="flex justify-between items-center bg-gray-100 p-2 rounded">
                    <span>${reward.name} (${reward.duration} นาที)</span>
                    <button class="delete-reward-btn text-red-500 hover:text-red-700" data-id="${id}">&times;</button>
                </div>
            `).join('');

            document.getElementById('add-reward-form').removeEventListener('submit', handleAddReward); // Prevent duplicate listeners
            document.getElementById('add-reward-form').addEventListener('submit', handleAddReward);
        }

        function renderCharts() {
            // Placeholder Data based on Eisenhower categories
            const completedTasks = Object.values(tasks).filter(t => t.isCompleted);
            const doCount = completedTasks.filter(t => t.eisenhower === 'do').length;
            const decideCount = completedTasks.filter(t => t.eisenhower === 'decide').length;
            const delegateCount = completedTasks.filter(t => t.eisenhower === 'delegate').length;
            const deleteCount = completedTasks.filter(t => t.eisenhower === 'delete').length;

            // Dummy data for weekly tasks completed
            const weeklyData = [doCount, decideCount, delegateCount, deleteCount, Math.floor(Math.random() * 5), Math.floor(Math.random() * 5), Math.floor(Math.random() * 5)];


            const tasksCompletedCtx = document.getElementById('tasksCompletedChart')?.getContext('2d');
            if (tasksCompletedCtx) new Chart(tasksCompletedCtx, {
                type: 'bar',
                data: { labels: ['จันทร์', 'อังคาร', 'พุธ', 'พฤหัสบดี', 'ศุกร์', 'เสาร์', 'อาทิตย์'], datasets: [{ label: 'งานที่เสร็จ', data: weeklyData, backgroundColor: 'rgba(59, 130, 246, 0.7)', borderRadius: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });

            const pomodoroSessionsCtx = document.getElementById('pomodoroSessionsChart')?.getContext('2d');
            if (pomodoroSessionsCtx) new Chart(pomodoroSessionsCtx, {
                type: 'doughnut',
                data: { labels: ['Do (สำคัญ/เร่งด่วน)', 'Decide (สำคัญ/ไม่เร่งด่วน)', 'Delegate (ไม่สำคัญ/เร่งด่วน)', 'Delete (ไม่สำคัญ/ไม่เร่งด่วน)'], datasets: [{ label: 'งานที่เสร็จตามประเภท', data: [doCount, decideCount, delegateCount, deleteCount], backgroundColor: ['#EF4444', '#3B82F6', '#F59E0B', '#6B7280'] }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }


        // --- Event Handlers ---
        function switchView(viewId) {
            if (!userId) return; // Prevent view switching before auth is complete
            currentView = viewId;
            const link = document.querySelector(`.nav-link[data-view="${viewId}"]`);
            if (link) viewTitle.textContent = link.querySelector('span').textContent;
            renderView(viewId);
        }

        function openTaskModal(task = null) {
            taskForm.reset();
            const taskIdInput = document.getElementById('task-id');
            const taskRewardSelect = document.getElementById('task-reward');

            // Populate rewards
            taskRewardSelect.innerHTML = '<option value="">ไม่มีรางวัล</option>' + Object.entries(rewards).map(([id, reward]) => `<option value="${id}">${reward.name} (${reward.duration} นาที)</option>`).join('');

            if (task) {
                modalTitle.textContent = "แก้ไขงาน";
                taskIdInput.value = task.id;
                document.getElementById('task-title').value = task.title;
                document.getElementById('task-description').value = task.description || '';
                document.getElementById('task-due-date').value = task.dueDate || '';
                document.getElementById('task-eisenhower').value = task.eisenhower || 'do';
                taskRewardSelect.value = task.rewardId || '';
            } else {
                modalTitle.textContent = "สร้างงานใหม่";
                taskIdInput.value = '';
            }
            taskModal.classList.remove('hidden');
        }

        function closeTaskModal() {
            taskModal.classList.add('hidden');
        }

        function openActionModal(title, message) {
            actionTitle.textContent = title;
            actionMessage.textContent = message;
            actionModal.classList.remove('hidden');
        }

        function closeActionModal() {
            actionModal.classList.add('hidden');
            // Ensure no lingering reward action listener
            startBreakBtn.removeEventListener('click', startBreakAction);
        }

        let rewardDurationMinutes = 0;
        const startBreakAction = () => {
            closeActionModal();
            // Start the break timer
            resetTimer(true);
            startTimer(rewardDurationMinutes * 60, true);
        };

        function handleTaskFormSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('task-id').value;
            const isEditing = !!id;

            const taskData = {
                title: document.getElementById('task-title').value,
                description: document.getElementById('task-description').value,
                dueDate: document.getElementById('task-due-date').value,
                eisenhower: document.getElementById('task-eisenhower').value,
                rewardId: document.getElementById('task-reward').value || null,
            };

            if (!isEditing) {
                taskData.isCompleted = false;
                taskData.createdAt = new Date().toISOString();
            }

            if (id) {
                update(ref(dataRef, `tasks/${id}`), taskData);
            } else {
                const newTaskRef = push(ref(dataRef, 'tasks'));
                set(newTaskRef, taskData);
            }
            closeTaskModal();
        }

        function handleTaskActions(e) {
            const button = e.target.closest('button');
            if (!button) return;
            const card = e.target.closest('.task-card');
            if (!card) return;
            const taskId = card.dataset.id;

            // Cleanup previous listeners before attaching new ones
            startBreakBtn.removeEventListener('click', closeActionModal);
            startBreakBtn.removeEventListener('click', startBreakAction);
            startBreakBtn.classList.remove('bg-gray-200', 'text-gray-700');
            startBreakBtn.classList.add('bg-green-600', 'text-white');
            closeActionBtn.classList.remove('hidden');

            if (button.classList.contains('delete-btn')) {
                const taskToDelete = tasks[taskId];
                if (taskToDelete) {
                    // Include deletion timestamp for trash sorting
                    set(ref(dataRef, `trash/${taskId}`), { ...taskToDelete, deletedAt: new Date().toISOString() });
                    remove(ref(dataRef, `tasks/${taskId}`));
                }
            } else if (button.classList.contains('edit-btn')) {
                openTaskModal({ id: taskId, ...tasks[taskId] });
            } else if (button.classList.contains('complete-btn')) {
                // Update task status and add completion timestamp
                update(ref(dataRef, `tasks/${taskId}`), { isCompleted: true, completedAt: new Date().toISOString() });

                const rewardId = card.dataset.rewardId;
                if (rewardId && rewards[rewardId]) {
                    const reward = rewards[rewardId];
                    rewardDurationMinutes = reward.duration;

                    actionTitle.textContent = "งานเสร็จแล้ว!";
                    actionMessage.textContent = `คุณได้รับรางวัล: ${reward.name} เป็นเวลาพัก ${reward.duration} นาที`;

                    startBreakBtn.textContent = `เริ่มพัก (${reward.duration} นาที)`;
                    startBreakBtn.classList.remove('hidden');

                    startBreakBtn.addEventListener('click', startBreakAction);
                } else {
                    actionTitle.textContent = "เยี่ยมมาก!";
                    actionMessage.textContent = "งานนี้เสร็จสิ้นแล้ว ไม่มีรางวัลพิเศษ";

                    // Primary action button becomes the confirmation/OK button
                    startBreakBtn.textContent = "ตกลง";
                    startBreakBtn.classList.remove('bg-green-600', 'text-white', 'hidden');
                    startBreakBtn.classList.add('bg-gray-200', 'text-gray-700');
                    closeActionBtn.classList.add('hidden'); // Hide secondary close button

                    startBreakBtn.addEventListener('click', closeActionModal, { once: true });
                }
                openActionModal(actionTitle.textContent, actionMessage.textContent);
            }
        }

        function handleRestoreTask(e) {
            const taskId = e.target.dataset.id;
            if (taskId && trash[taskId]) {
                const { deletedAt, ...restoredTask } = trash[taskId]; // Remove deletion metadata
                restoredTask.isCompleted = false; // Ensure it's active again

                set(ref(dataRef, `tasks/${taskId}`), restoredTask);
                remove(ref(dataRef, `trash/${taskId}`));
            }
        }

        function handleAddReward(e) {
            e.preventDefault();
            const name = document.getElementById('reward-name').value;
            const duration = document.getElementById('reward-duration').value;
            if (name && duration && dataRef) {
                const newRewardRef = push(ref(dataRef, 'rewards'));
                set(newRewardRef, { name, duration: parseInt(duration) });
                e.target.reset();
            }
        }

        function handleDeleteReward(e) {
            const rewardId = e.target.dataset.id;
            if (rewardId && dataRef) {
                remove(ref(dataRef, `rewards/${rewardId}`));
            }
        }

        // --- Initial Setup ---

        // Timer Button Handlers
        startPauseBtn.addEventListener('click', toggleTimer);
        resetBtn.addEventListener('click', () => resetTimer(isBreak));

        // Modal Handlers (Close button is always present for cancellation)
        closeActionBtn.addEventListener('click', closeActionModal);

        sidebarToggle.addEventListener('click', () => sidebar.classList.toggle('sidebar-closed'));

        navLinks.forEach(link => link.addEventListener('click', (e) => {
            e.preventDefault();
            switchView(e.currentTarget.dataset.view);
            if (window.innerWidth < 768) sidebar.classList.add('sidebar-closed');
        }));

        addTaskBtn.addEventListener('click', () => openTaskModal());
        cancelTaskBtn.addEventListener('click', closeTaskModal);
        taskForm.addEventListener('submit', handleTaskFormSubmit);

        // Event delegation for dynamic content
        document.getElementById('eisenhower-view').addEventListener('click', handleTaskActions);
        document.getElementById('trash-view').addEventListener('click', e => {
            if (e.target.classList.contains('restore-btn')) handleRestoreTask(e);
        });
        document.getElementById('settings-view').addEventListener('click', e => {
            const deleteBtn = e.target.closest('.delete-reward-btn');
            if (deleteBtn) handleDeleteReward({ target: deleteBtn });
        });

        // Set initial timer state
        resetTimer(false);

    </script>
</body>

</html>